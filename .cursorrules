# RÃˆGLES CURSOR â€“ PROJET ARTISANFLOW

Tu travailles EXCLUSIVEMENT sur le projet mobile React Native **ArtisanFlow**.

---

## 1. CONTEXTE PROJET

ArtisanFlow utilise :
- React Native + Expo
- Supabase (avec RLS activÃ©)
- Zustand
- IA de gÃ©nÃ©ration de devis (Whisper + GPT-4o-mini)
- Gestion des chantiers / clients / photos / vocaux

Tu NE DOIS PAS mÃ©langer avec d'autres projets (ex : Tredora).  
Si une demande ressemble Ã  un autre projet (web, Vinted, ISBN, etc.), tu dois demander :
> Â« Est-ce bien pour ArtisanFlow ? Â»

---

## 2. DONNÃ‰ES UTILISATEURS (MULTI-TENANT)

### Principe absolu
> Chaque artisan ne voit QUE ses propres donnÃ©es. JAMAIS celles d'un autre.

### RÃ¨gles Supabase

Les requÃªtes sur les tables liÃ©es aux donnÃ©es d'un utilisateur doivent **toujours filtrer par utilisateur** (ex : `user_id`).

Tu dois **signaler et corriger** toute requÃªte du type `.select('*')` **sans filtre utilisateur** sur des donnÃ©es sensibles.

**Exemple :**

```javascript
// âœ… OK
const { data } = await supabase
  .from('projects')
  .select('*')
  .eq('user_id', userId);

// âš ï¸ Ã€ SIGNALER / CORRIGER
const { data } = await supabase
  .from('projects')
  .select('*'); // â† Manque le filtre user_id
```

### Tables concernÃ©es (12 tables)

`profiles`, `brand_settings`, `clients`, `projects`, `devis`, `devis_lignes`, `factures`, `notes`, `project_photos`, `client_photos`, `devis_ai_sessions`, `devis_temp_ai`, `user_price_stats`

### RLS (Row Level Security)

- âœ… ActivÃ© sur toutes les tables
- Les policies filtrent par `auth.uid()`
- âŒ **Ne JAMAIS dÃ©sactiver RLS**, mÃªme temporairement

### En cas de doute

**STOP et demande confirmation** avant de modifier quoi que ce soit qui touche aux requÃªtes utilisateurs.

---

## 3. CLÃ‰S, SECRETS ET ENV

### Tu PEUX utiliser cÃ´tÃ© client

```javascript
EXPO_PUBLIC_SUPABASE_URL
EXPO_PUBLIC_SUPABASE_ANON_KEY
```

PrivilÃ©gie les variables d'environnement (`process.env.EXPO_PUBLIC_*`) et un fichier de config (ex : `config/supabase.js`).

### Tu NE DOIS PAS

- Introduire de vraies clÃ©s secrÃ¨tes cÃ´tÃ© client (service role, Stripe secret, admin, etc.)
- Proposer de mettre une clÃ© sensible directement dans le code

### Si tu vois une clÃ© sensible dans le code

1. **Signale-la**
2. **Propose de la dÃ©placer cÃ´tÃ© serveur** (Edge function, backend, Make, etc.)

---

## 4. MÃ‰THODE DE TRAVAIL

### Avant de modifier du code, tu dois

1. **Lire** le code existant
2. **Expliquer** en franÃ§ais ce qu'il fait
3. **Proposer** clairement le changement
4. **Expliquer** comment tester

### Format conseillÃ©

```
ğŸ“ Fichiers concernÃ©s : ...
ğŸ” ProblÃ¨me identifiÃ© : ...
âœ… Solution proposÃ©e : ...
ğŸ§ª Comment tester : ...
```

---

## 5. LIMITES

Tu Ã©vites autant que possible :
- Les gros refactors non demandÃ©s
- De toucher Ã  plusieurs zones sans lien dans une seule passe
- De modifier les rÃ¨gles RLS / policies Supabase sans expliquer clairement l'impact

Si la demande est floue (ex : Â« optimise tout Ã§a Â»), tu commences par un **diagnostic** puis tu proposes des **petites Ã©tapes**, pas un bulldozer.

---

## 6. ANTI-PATTERNS INTERDITS

Tu NE DOIS JAMAIS :
- âŒ Supprimer du code sans Ãªtre certain qu'il est inutilisÃ©
- âŒ DÃ©sactiver RLS mÃªme temporairement (Â« juste pour tester Â»)
- âŒ Faire plusieurs changements non liÃ©s en une seule passe
- âŒ Copier-coller sans comprendre
- âŒ Proposer des changements cosmÃ©tiques non demandÃ©s
- âŒ CrÃ©er des requÃªtes sans filtre `user_id` sur des donnÃ©es utilisateurs

---

## 7. AVANT DE VALIDER

### VÃ©rifications obligatoires

- âœ… Pas d'erreurs de lint
- âœ… Tester l'isolation utilisateurs (crÃ©er 2 comptes test et vÃ©rifier qu'un artisan ne voit pas les donnÃ©es de l'autre)
- âœ… Tester les cas limites (offline, erreurs rÃ©seau, timeouts)
- âœ… Tester sur device rÃ©el si possible (Android/iOS)

### Tests manuels recommandÃ©s

```bash
npm run lint        # VÃ©rifier le code
npm test            # Lancer les tests
npm run format      # Formater le code
```

---

## 8. ARCHITECTURE DU PROJET

### Structure des dossiers

```
artisanflow/
â”œâ”€â”€ components/          # Composants rÃ©utilisables
â”œâ”€â”€ screens/             # Ã‰crans de l'app
â”œâ”€â”€ services/            # Services API (requÃªtes Supabase, IA, etc.)
â”œâ”€â”€ navigation/          # Navigation React Navigation
â”œâ”€â”€ store/               # State management Zustand
â”œâ”€â”€ theme/               # ThÃ¨me centralisÃ©
â”œâ”€â”€ utils/               # Utilitaires
â”œâ”€â”€ hooks/               # Hooks personnalisÃ©s
â”œâ”€â”€ validation/          # Validation Zod
â”œâ”€â”€ sql/                 # Scripts SQL
â”œâ”€â”€ supabase/functions/  # Edge Functions
â””â”€â”€ config/              # Configuration (Supabase, etc.)
```

### Fichiers sensibles Ã  surveiller

- Tous les fichiers dans `/services/` (requÃªtes Supabase)
- Tous les fichiers dans `/screens/` (affichage donnÃ©es users)
- Les composants qui affichent des listes (clients, chantiers, etc.)

---

## 9. CONVENTIONS DE CODE

### Naming

- Composants : `PascalCase.js`
- Hooks : `useCamelCase.js`
- Utils : `camelCase.js`
- Constants : `UPPER_SNAKE_CASE`

### Imports (ordre recommandÃ©)

```javascript
// 1. React
import React, { useState, useEffect } from 'react';

// 2. React Native
import { View, Text, TouchableOpacity } from 'react-native';

// 3. Libraries
import { Feather } from '@expo/vector-icons';

// 4. Local
import { supabase } from '../supabaseClient';
import { useSafeTheme } from '../theme/useSafeTheme';
```

---

## 10. EN RÃ‰SUMÃ‰

1. **Lire avant de modifier**
2. **Un changement Ã  la fois**
3. **Isolation utilisateurs = SACRÃ‰**
4. **Expliquer en franÃ§ais**
5. **Tester avant de valider**

**Ces rÃ¨gles sont permanentes et non-nÃ©gociables.**

---

**Version** : 1.3.0  
**DerniÃ¨re mise Ã  jour** : 10 Novembre 2025

